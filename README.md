# Cataract-Video-Analysis
It includes matlab codes to register and crop cataract videos, find segmentation images, track best fitting line and instruments tip locations.

Stage 1 guidance:
For realizing stage 1, Step1_VR_0_HD_prepare-rev1.m, Step1_VR_1_HD_reg_usingFixedTemp.m, Step1_VR_2_HD_reg_usingAdaptedTemp_enhanced.m and  Step1_VR_3_2_HD_SnakeContour_transform2HSV_03012016-rev1.m should be carried out in order.

Based on stage1 algorithm, we can get a good segmentation result from saturation image. Every frame is 600x600 pixel, and the diameter of pupil is about 500 pixel. The location of pupil in every frame is stabilized and rarely moved. The instrument in black and white segmented image is clearly labeled as white pixels, while other areas including pupil and background are labeled as black pixels. In the meanwhile, the bright area at the center of pupil will also be labeled as white pixels in the case that instrument is close to this bright area. Otherwise it would be labeled as black pixels as well. The work of stage 2 is to identify the number of instrument and get the tip location of instrument. In other words, needle or closed forceps should have only one tip, and opened forceps should have two tips in final result.
1.	In order to get rid of the effect of bright area in some frames, I use a mask to veil the upper part of every frame to remove the bright area. The height of mask may vary in different cases. In most of cases, it is 300 pixels though.
2.	Then I try to find the number of connected areas in under part of every frame. The algorithm to find connected areas will be introduced later. After we get the number of connected areas, we can decide the following operation. In one frame, for example, there is only one connected area. We know the instrument must be a needle or a closed forceps. In both cases, there is only one tip. In some other frames, there could be more than one connected area. Then I choose the largest two areas. These are two arms of the opened forceps. Correspondingly, there are two tips in these frames.
3.	After identifying the instrument, I use PCA to find the best fitting line for every frame. PCA should be applied to the under part still, since the bright area may confuse PCA to find the inaccurate fitting line. If there is only one connected area, only one best fitting line is decided. If there are more than one connected area, two best fitting line are decided.
4.	In this step, I find the tip location. We need to remove the mask in this step. Since we have the best fitting line, we know that the tip location must be on this line somewhere. Thus the bright area will affect us no more. Remember we have the pupil information. So I find all the white pixels and black pixels on best fitting line in pupil, and every pixel has a row coordinate and a column coordinate. I sort these pixels in descending order of row coordinate. The final white pixel in this order is the tip of instrument. If there are two lines, do this operation twice to find two tips.


Find connected area:
Traverse every pixel in one frame. Let us start from upper-left pixel. If it is a black pixel, we do nothing and go to next right pixel. If it is a white pixel, we check if it has a class. If not, we give it a new class. Then we check right pixel, under-left pixel, under pixel and under-right pixel of this white pixel. Combine different classes into one class and give unclassed pixel this class. Then we go to next right pixel.
